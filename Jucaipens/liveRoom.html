<!DOCTYPE html>
<html>

	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<title></title>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" />
		<link href="css/style.css" rel="stylesheet" type="text/css" />
		<link rel="stylesheet" href="css/mui.min.css" />
		<script type="text/javascript" src="js/stringUtil.js" ></script>
		<script type="text/javascript" src="js/mui.min.js"></script>
		<script type="text/javascript">
			mui.init();
			mui.plusReady(function() {
				var web = plus.webview.currentWebview();
				var chatLay = document.getElementById("chatLay");
				var live = document.getElementById("live");
				var liveResourcePath = "http://121.40.227.121:8080/AccumulateWealth/jucaipen/videoResource";
				var chatPath = "http://121.40.227.121:8080/AccumulateWealth/jucaipen/chatMessage";
				var topIdPath = "http://chat.jucaipen.com/ashx/chat_msg.ashx?action=getTopId";
				var getChatMsgPath = "http://chat.jucaipen.com/ashx/chat_msg.ashx?action=getlist";
				var sendMsgPath="http://chat.jucaipen.com/ashx/chat_msg.ashx?action=add";
				var uId = plus.storage.getItem("userId");
				var liveId = web.liveId;
				var msgType = 0;
				var topId;
				var roomFace=web.face;
				var isManager = plus.storage.getItem("isManager");
				var isServer = plus.storage.getItem("isServer");
				var userNmae = plus.storage.getItem("userName");
				var bd=document.getElementById("bd");
				bd.style.background="#888888";
				//获取视频资源
				mui.ajax(liveResourcePath, {
					data: {
						id: liveId,
						typeId: 0
					},
					type: "get",
					dataType: "json",
					timeout: 10000,
					success: function(data) {
						live.src=data.videoUrl;
					},
					error: function(e) {
					}
				})
				//intoRoom(msgType,uId,liveId,isManager,isServer,userNmae,0,"",0);
				var isManager = plus.storage.getItem("isManager");
				var isServer = plus.storage.getItem("isServer");
				var userId = plus.storage.getItem("userId");
				getTopId(isManager, liveId, isServer);
				
				
				function getMsgForEver(){
					setInterval(function(){
					var content = chatLay.innerHTML;
					mui.ajax(getChatMsgPath, {
						data: {
							topId: topId,
							roomid: liveId,
							userId: userId,
							isServer: isServer
						},
						dataType: "json",
						type: "post",
						success: function(data) {
							if(data.length>0){
							var myDate=subStr(1,data[i].SendDate);
							 topId=data[data.length-1].Id+1;
							for (var i = 0; i < data.length; i++) {
								content = content + "<li><span id='chat-time'>"+myDate+"</span><span id='sp_head'>" + "<img src='image/guan.png' id='iv_head'/>" + "</span><span id='chat-name'>" + data[i].SendUserName + "</span>" + "<span id='chat-content'>" + data[i].MessBody + "</span></li>";
							}
							chatLay.innerHTML = content;
							chatLay.scrollTop=chatLay.scrollHeight;
							}
						},
						error: function(e) {
						}
					})
				
				},3000);
				}
				
				
				//通知服务器 进入直播室
				function intoRoom(msgType, fromUser, roomId, isManager, isServer, userName, chatType, message, toUser) {
					//msgType  
					//fromUser
					//roomId
					//isManager
					//isServer
					//userName
					mui.ajax(chatPath, {
						data: {
							messageObject: "{msgType:" + msgType + ",fromUser:" + uId + ",roomId:" + roomId + ",isManager:" + isManager + ",isServer:" + isServer + ",userName:" + userName + "}"
						},
						type: "get",
						dataType: "json",
						timeout: 10000,
						success: function(data) {
							//console.log(JSON.stringify(data));
						},
						error: function(e) {
						}
					})
				}
				//监听推送消息
				plus.push.addEventListener("receive", function(msg) {
					//{"content","payload","title","_UUID_"}
					var content = chatLay.innerHTML;
					content = content + "<li><span id='chat-time'>"+data[i].SendDate+"</span><span id='sp_head'>" + "<img src='image/guan.png' id='iv_head'/>" + "</span><span id='chat-name'>张三</span>" + "<span id='chat-content'>" + msg.content + "</span></li>";
					chatLay.innerHTML = content;
				})
				//获取最近倒数第十条消息ID
				function getTopId(isManager, roomId, isServer) {
					mui.ajax(topIdPath, {
						data: {
							userType: isManager,
							topCount: 10,
							roomId: roomId,
							isServer: isServer
						},
						dataType: "json",
						type: "post",
						success: function(data) {
							topId = JSON.stringify(data);
							getChatMessaged();
						},
						error: function(e) { 
							
						}
					})
				}

				function getChatMessaged() {
					var content = chatLay.innerHTML;
					mui.ajax(getChatMsgPath, {
						data: {
							topId: topId,
							roomid: liveId,
							userId: userId,
							isServer: isServer
						},
						dataType: "json",
						type: "post",
						success: function(data) {
							if(data.length>0){
							topId=data[data.length-1].Id+1;
							for (var i = 0; i < data.length; i++) {
								var myDate=subStr(1,data[i].SendDate);
								content = content + "<li ><span id='chat-time'>"+myDate+"</span><span id='sp_head'>" + "<img src='image/guan.png' id='iv_head'/>" + "</span><span id='chat-name'>" + data[i].SendUserName + "</span>" + "<span id='chat-content'>" + data[i].MessBody + "</span></li>";
							}
							chatLay.innerHTML = content;
							}
							getMsgForEver();
						},
						error: function(e) {
						}
					})
				}
				var btn_send=document.getElementById("btn-send");
				var content=document.getElementById("msg-content");
				var userName=plus.storage.getItem('userName');
				btn_send.addEventListener('tap',function(){
					if(content.value.length<=0){
						mui.toast('发送消息不能为空');
						return ;
					}
					sendMsg(content,userName);
					
				})
				
				//发送消息
				function sendMsg(c,uName){
					console.log('c'+c+"  "+uName+"  "+userId+"   "+liveId);
					mui.ajax(sendMsgPath,{
						data:{
							msgcontent:c,
							sendusername:uName,
							SendUserId:userId,
							roomid:liveId
						},
						type:"post",
						dataType:"json",
						success: function(data){
							console.log(JSON.stringify(data));
						},
						error: function(e){
							console.log("err");
							
						}
					})
				}
				
			})
		</script>

		<style type="text/css">
			.pagebody {
				margin: 10px;
				overflow: hidden;
			}
			
			#chat-time {
				background: #505050 none repeat scroll 0% 0%;
				border-radius: 2px;
				padding: 2px 5px;
				color: #FFF;
				height: 1.5rem;
				line-height: 1.5rem;
			}
			
			#chat-name {
				background: #BD0B19 none repeat scroll 0% 0%;
				color: #FFF;
				border-radius: 2px;
				padding: 2px 5px;
				height: 1.5rem;
				line-height: 1.5rem;
			}
			
			#chat-content {
				line-height: 1.5rem;
				min-height: 1.5rem;
				padding: 2px;
				color: #000;
			}
			
			#iv_head {
				height: 1.5rem;
			}
			
			#sp_head {
				height: 1.5rem;
				line-height: 1.5rem;
				padding: 2px;
			}
			
			.chat_div_btn ul li {
				width: 100%;
				float: left;
				padding: 5px 0px;
			}
			
			.mui-content {
				margin-top: 40px;
			}
			#bd{
				background-size: 100% 100%;
			}
		</style>

	</head>

	<body>
		<header class="header">
			<div class="head">
				<div class="denglu1 mui-action-back">
					<a><img src="image/into_back.png" style="margin-top:0.2rem;" /></a>
				</div>
				<div class="logo1" style="margin-top:0.2rem;">
					<span>直播室</span>
				</div>
			</div>
		</header>
		<div class="mui-content">
			<div style="width: 100%;height: 250px;position: fixed;">
				<div style="width: 100%;height: 250px;position: fixed;" id="bd" >
					<embed width='100%' height='100%' id="live"></embed>
				</div>
			</div>

			<div class="pagebody">
				<div class="pagebody_mid">
					<div class="chat_div_btn">
						<ul id="chatLay">
						</ul>
					</div>
				</div>
			</div>

			<div class="sendMsg" style="position: fixed;bottom: 0px;width: 100%;">
				<div class="msgContent" style="float: left;width: 80%;height: 45px;">
					<input type="text" style="width: 100%;height: 100%;border-right: solid white;" id="msg-content"/>
				</div>

				<div class="btn_send" style="float: right;width: 20%;height: 45px;">
					<button type="button" class="mui-btn" style="background: #bb1121;width: 100%;color: white;height: 100%;font-size: 20px;" id="btn-send">发送</button>
				</div>
			</div>

		</div>
	</body>

</html>