<!DOCTYPE html>
<html>

	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<title></title>
		<script src="js/mui.min.js"></script>
		<link href="css/mui.min.css" rel="stylesheet" />
		<link href="css/tuch.css" rel="stylesheet" type="text/css" />
		<link href="css/style.css" rel="stylesheet" type="text/css" />
		<script type="text/javascript" charset="UTF-8">
			mui.init();
			mui.plusReady(function() {
				var web = plus.webview.currentWebview();
				var chatLay=document.getElementById("chatLay");
				var live = document.getElementById("live");
				var liveResourcePath="http://121.40.227.121:8080/AccumulateWealth/jucaipen/videoResource";
				var chatPath="http://192.168.1.61:8080/AccumulateWealth/jucaipen/chatMessage";
				var uId=plus.storage.getItem("userId");
				var liveId = web.liveId;
				var msgType=0;
				var isManager=plus.storage.getItem("isManager");
				var isServer=plus.storage.getItem("isServer");
				var userNmae=plus.storage.getItem("userName");

				//获取视频资源
				mui.ajax(liveResourcePath, {
					data: {
						id: liveId,
						typeId: 0
					},
					type: "get",
					dataType: "json",
					timeout: 10000,
					success: function(data) {
						var liveUrl = "<embed width='100%' height='250px' src=" + data.videoUrl + "></embed>";
						live.innerHTML = liveUrl;
					},
					error: function(e) {}
				})
				
				intoRoom(msgType,uId,liveId,isManager,isServer,userNmae,0,"",0);
				
				
				
				//通知服务器 进入直播室
				function intoRoom(msgType,fromUser,roomId,isManager,isServer,userName,chatType,message,toUser){
					//msgType  
					//fromUser
					//roomId
					//isManager
					//isServer
					//userName
					mui.ajax(chatPath,{
						data:{  
							messageObject:"{msgType:"+msgType+",fromUser:"+uId+",roomId:"+roomId+",isManager:"+isManager+",isServer:"+isServer+",userName:"+userName+"}"
						},
						type:"get",
						dataType:"json",
						timeout:10000,
						success: function(data){
							console.log(JSON.stringify(data));
						},
						error: function(e){
							
						}
					})
					
					
				}
				
				
				//监听推送消息
				plus.push.addEventListener("receive",function(msg){
					//{"content","payload","title","_UUID_"}
					var content=chatLay.innerHTML;
					content =content+"<li><span id='chat-time'>11:22</span><span id='sp_head'>"
							+"<img src='image/guan.png' id='iv_head'/>"
								+"</span><span id='chat-name'>张三</span>"
								+"<span id='chat-content'>"+msg.content+"</span></li>";
					chatLay.innerHTML=content;
				})
				
			})
		</script>

		<style type="text/css">
			.pagebody {
				margin: 10px;
			}
			
			#chat-time {
				background: #505050 none repeat scroll 0% 0%;
				border-radius: 2px;
				padding: 2px 5px;
				color: #FFF;
				height: 1.5rem;
				line-height: 1.5rem;
			}
			
			#chat-name {
				background: #BD0B19 none repeat scroll 0% 0%;
				color: #FFF;
				border-radius: 2px;
				padding: 2px 5px;
				height: 1.5rem;
				line-height: 1.5rem;
			}
			
			#chat-content {
				line-height: 1.5rem;
				min-height: 1.5rem;
				padding: 2px;
				color: #000;
			}
			
			#iv_head {
				height: 1.5rem;
			}
			
			#sp_head {
				height: 1.5rem;
				line-height: 1.5rem;
				padding: 2px;
			}
			
			.chat_div_btn ul li {
				width: 100%;
				float: left;
				padding: 5px 0px;
			}
		</style>

	</head>

	<body>
		<header class="mui-bar mui-bar-nav" style="background: #CF2D28;">
			<a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left"></a>
			<h1 class="mui-title" style="color: white;">直播室</h1>
		</header>
		<div class="mui-content">
			<div class="mui-content" style="width: 100%;">
				<div style="width: 100%;" id="live">
					<embed width='100%' height='250px' src=" "></embed>
				</div>

			</div>

			<div class="pagebody">
				<div class="pagebody_mid">
					<div class="chat_div_btn">
						<ul id="chatLay">
						</ul>
					</div>
				</div>
			</div>

		</div>
	</body>

</html>