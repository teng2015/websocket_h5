<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">

	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" />
		<link href="css/style.css" rel="stylesheet" type="text/css" />
		<title> </title>
		<!--标准mui.css-->
		<link rel="stylesheet" href="css/mui.min.css">

		<script src="js/mui.min.js"></script>
		<script type="text/javascript" src="js/stringUtil.js"></script>
		<link rel="stylesheet" href="css/app.css" />
		<script type="text/javascript" charset="UTF-8">
			mui.init({
				gestureConfig: {
					hold: true,
					release: true
				}
			});
			mui.plusReady(function() {
				var news_detailUrl = "http://121.40.227.121:8080/AccumulateWealth/accumulate/newsDetail";
				var relate_news = "http://121.40.227.121:8080/AccumulateWealth/jucaipen/relateArticle";
				var add_remark = "http://121.40.227.121:8080/AccumulateWealth/jucaipen/remarkNews";
				var querry_comm = 'http://121.40.227.121:8080/AccumulateWealth/jucaipen/querryComm';
				var add_goods = "http://121.40.227.121:8080/AccumulateWealth/jucaipen/addGood";
				var collectNews = "http://121.40.227.121:8080/AccumulateWealth/jucaipen/collectNews";
				var queryCollect = "http://121.40.227.121:8080/AccumulateWealth/jucaipen/querryNewsCollect";
				var list = document.getElementById("lv-share");
				var web = plus.webview.currentWebview();
				var title = document.getElementById("show_newstit");
				var repoter = document.getElementById("show_newsinfo");
				var content = document.getElementById("show_newsbody");
				var relate = document.getElementById("data-relate");
				var comm_count = document.getElementById("show_Video_CommCount");
				var comment = document.getElementById("newscommlist");
				var inputs = document.getElementById("input");
				var myinput = document.getElementById("myinput");
				var HiddenFieldId = document.getElementById("HiddenFieldId");
				var btn_sub_comm = document.getElementById("btn_sub_comm");
				var getMore = document.getElementById("getMore");
				var li_share = document.getElementById("li-share");
				var iv_share = document.getElementById("iv-share");
				var iv_collect = document.getElementById("iv-collect");
				var li_collect = document.getElementById("li-collect");
				var more = document.getElementById("more");
				var li_more = document.getElementById("li-more");
				var moreLoad=document.getElementById("moreLoad");
				var bhref = false;
				var isCollected;
				var currentPage = 1;
				var totlePage;
				var id = web.newsId;
				var share;
				var appenStr = "";
				var classId;
				var typeId = 0;
				var uId;
				if (id <= 0) {
					plus.nativeUI.toast("新闻ID异常");
					return;
				}
				findCollectState();
				//获取新闻详细信息
				mui.ajax(news_detailUrl, {
					data: {
						id: id
					},
					dataType: "json",
					type: "get",
					timeout: 10000,
					success: function(data) {
						title.innerHTML = data.title;
						repoter.innerHTML = data.from + "&nbsp;&nbsp;发布时间：" + subStr(2, data.publishDate);
						content.innerHTML = data.Bodys;
					},
					error: function(e) {}
				});
				//获取相关新闻
				var relaUrl = "";
				mui.ajax(relate_news, {
					data: {
						id: id
					},
					dataType: "json",
					type: "get",
					timeout: 10000,
					success: function(data) {
						for (var i = 0; i < data.length; i++) {
							relaUrl = relaUrl + "<li id=" + data[i].id + ">•<a>" + data[i].title + "</a></li>";
						}
						relate.innerHTML = relaUrl;
						mui("#data-relate").on("tap", "li", function() {
							var nId = this.getAttribute("id");
							mui.openWindow({
								url: "newsDetail.html",
								id: "newsDetail",
								extras: {
									newsId: nId
								},
								waiting: {
									autoShow: false
								},
								createNew: true //重新创建页面
							})
						})
					},
					error: function(e) {}
				});
				findCommList(currentPage);

				function findCommList(p) {
					//获取评论信息
					var commUrl = "";
					mui.ajax(querry_comm, {
						data: {
							typeId: typeId,
							id: id,
							pager: p
						},
						dataType: "json",
						type: "get",
						timeout: 10000,
						success: function(data) {
							if(moreLoad.style.display='block'){
								moreLoad.style.display='none';
							}
							comm_count.innerHTML = "共" + data.length + "条";
							for (var i = 0; i < data.length; i++) {
								totlePage = data[0].totlePage;
								var logoStr = data[i].userLogo;
								var myDate = subStr(3, data[i].insertDate);
								if (logoStr.indexOf("121.40.227.121") > 0) {
									logoStr = "http://121.40.227.121:8080/AccumulateWealth/jucaipen/downUserLogo?filename=" + logoStr;
								}
								commUrl = commUrl + "  <li><div  class='headFace'><img  style='border-radius:50%;width:50px;height:50px;' id='headLogo' src=" + isNull(logoStr) + " />" + "	</div><div id='vItem' ><h4 ><span id='nickName'>" + data[i].userName + "</span>" +
									"<span id='sp_good' class=" + data[i].id + "><img src='image/good.png' id='iv_good' />" +
									"</span><span id='sp_comm'  class=" + data[i].id + " name=" + data[i].userName + "><img src='image/comm_icon1.png' id='iv_comm'/>" +
									"</span></h4><span id='comBody' style='margin-left:10px;'>" + data[i].body + "</span><span id='commTime'>" +
									myDate + "</span>" + "	</div></li> "
							}
							comment.innerHTML = commUrl;
							if (currentPage < totlePage) {
								getMore.style.display = 'block';
							} else {
								getMore.style.display = 'none';
							}
							if (data.length > 0) {
								//点赞
								mui("#newscommlist").on("tap", "#sp_good", function() {
									uId = plus.storage.getItem("userId");
									var commId = this.getAttribute("class");
									if (uId <= 0) {
										mui.openWindow({
											url: "login.html",
											id: "login"
										})
										return;
									}
									mui.ajax(add_goods, {
										data: {
											userId: uId,
											commId: commId
										},
										dataType: "json",
										type: "get",
										timeout: 10000,
										success: function(data) {
											if (data.ret_code == 0) {
												plus.nativeUI.toast("点赞成功");
											} else {
												plus.nativeUI.toast(data.err_msg);
											}
										},
										error: function(e) {
											plus.nativeUI.toast("连接失败");
										}
									});
								});
								//回复评论
								mui("#newscommlist").on("tap", "#sp_comm", function() {
									var name = this.getAttribute("name");
									var commId = this.getAttribute("class");
									myInputState(commId, "回复@" + name + "的评论:");
								})
							}
						},
						error: function(e) {}
					});
				}
				//设置默认图片
				function isNull(str) {
					if (str.length <= 0 || str == null) {
						return 'image/head.png';
					}
					return str;
				}
				//获取收藏状况
				function findCollectState() {
					var uId = plus.storage.getItem("userId");
					if (uId <= 0) {
						return;
					}
					mui.ajax(queryCollect, {
						data: {
							userId: uId,
							newsId: id
						},
						type: "get",
						dataType: "json",
						timeout: 10000,
						success: function(data) {
							if (data.ret_code == 0) {
								iv_collect.src = "image/collect_s.png";
								isCollected = true;
							} else {
								iv_collect.src = "image/collect_c.png";
								isCollected = false;
							}
						},
						error: function(e) {}
					})
				}
				//收藏资讯
				function collectNewsOp(t) {
					mui.ajax(collectNews, {
						data: {
							type: t,
							userId: uId,
							newsId: id
						},
						dataType: "json",
						type: "get",
						timeout: 10000,
						success: function(data) {
							if (t == 0) {
								if (data.ret_code == 0) {
									isCollected = true;
									iv_collect.src = "image/collect_s.png";
								} else {
									isCollected = false;
								}
							} else {
								if (data.ret_code == 0) {
									isCollected = false;
									iv_collect.src = "image/collect_c.png";
								} else {
									isCollected = true;
								}
							}
						},
						error: function(e) {}
					})
				}
				li_collect.addEventListener("tap", function() {
						mui(".mui-popover").popover('hide');
						uId = plus.storage.getItem("userId");
						if (uId <= 0) {
							mui.openWindow({
								url: "login.html",
								id: "login"
							})
							return;
						}
						if (isCollected) {
							//取消收藏
							collectNewsOp(1);
						} else {
							//收藏
							collectNewsOp(0);
						}
					})
					//弹出评论／回复框
				inputs.addEventListener("tap", function() {
					myInputState(0, "想说点什么");
				});
				//发表评论，回复
				btn_sub_comm.addEventListener("tap", function() {
						if (HiddenFieldId.value.length <= 0) {
							plus.nativeUI.toast("请输入内容");
							return;
						}
						remarkNews();
					})
					//弹出评论／回复对话框
				function myInputState(cId, str) {
					uId = plus.storage.getItem("userId");
					if (uId <= 0) {
						mui.openWindow({
							url: "login.html",
							id: "login"
						})
						return;
					}
					var d = myinput.style.display;
					HiddenFieldId.value = "";
					if (d == "block") {
						myinput.style.display = "none";
					} else {
						myinput.style.display = "block";
						classId = cId;
						if (cId > 0) {
							appenStr = str;
						}
						HiddenFieldId.placeholder = str;
					}
				}
				//发表评论／回复
				function remarkNews() {
					mui.ajax(add_remark, {
						data: {
							typeId: typeId,
							classId: classId,
							userId: uId,
							newsId: id,
							bodys: appenStr + HiddenFieldId.value
						},
						dataType: "json",
						type: "post",
						timeout: 10000,
						success: function(data) {
							if (data.ret_code) {
								plus.nativeUI.toast("评论发表成功");
								HiddenFieldId.value = "";
							} else {
								plus.nativeUI.toast(data.err_msg);
							}
						},
						error: function(e) {}
					})
				}
				//获取更多评论信息
				getMore.addEventListener("tap", function() {
					  getMore.style.display='none';
					if (currentPage < totlePage) {
						moreLoad.style.display='block';
						findCommList(++currentPage);
					}
				});
				//分享点击事件
				li_share.addEventListener("hold", function() {
						iv_share.src = 'image/share_press.png';
					})
					//分享按钮释放事件
				li_share.addEventListener("release", function() {
						iv_share.src = 'image/share_normal.png';
						mui(".mui-popover").popover('hide');
					})
					//分享
				li_share.addEventListener("tap", function() {
						updateSerivces();
						console.log(JSON.stringify(share));
						shareShow(share);
					})
					// 打开分享
				function shareShow(s) {
					bhref = false;
					var ids = [{
							id: "weixin",
							ex: "WXSceneSession"
						}, {
							id: "weixin",
							ex: "WXSceneTimeline"
						}, {
							id: "sinaweibo"
						}, {
							id: "tencentweibo"
						}],
						bts = [{
							title: "发送给微信好友"
						}, {
							title: "分享到微信朋友圈"
						}, {
							title: "分享到新浪微博"
						}, {
							title: "分享到腾讯微博"
						}];
					if (plus.os.name == "iOS") {
						ids.push({
							id: "qq"
						});
						bts.push({
							title: "分享到QQ"
						});
					}
					plus.nativeUI.actionSheet({
							cancel: "取消",
							buttons: bts
						},
						function(e) {
							var i = e.index;
							if (i > 0) {
								shareAction(s);
							}
						}
					);
				}
				/**
				 * 更新分享服务
				 */
				function updateSerivces() {
					plus.share.getServices(function(s) {
						share = s;
					}, function(e) {
						console.log("获取分享服务列表失败：" + e.message);
					});
				}

				function shareAction(s) {
					console.log("action:" + JSON.stringify(s));
					if (!s) {
						console.log("null");
						return;
					}
					if (s.authenticated) {
						console.log("正在认证");
						shareMessage(s);
					} else {
						console.log(JSON.stringify(s));
						shareMessage(s);
						/*s.authorize(shareMessage, function(e) {
							alert("未进行认证");
						})*/
					}
				}
				/**
				 * 发送分享消息
				 * @param
				 */
				function shareMessage(s) {
					share[0].send({
						content: "Hello"
					}, function() {
						console.log("成功");
					}, function(e) {
						console.log("失败");
					});
				}
				li_more.addEventListener("tap", function() {
					mui(".mui-popover").popover('hide');
				})
			})
		</script>

		<style type="text/css">
			#newscommlist {
				float: left;
				display: block;
			}
			
			#newscommlist li {
				width: 100%;
				float: left;
				display: block;
				margin-top: 0.7rem;
			}
			
			.headFace {
				width: 15%;
			}
			
			#headLogo {
				width: 100%;
				border-radius: 50%;
			}
			
			#vItem {
				width: 83%;
				margin-left: 2%;
				border-bottom: 1px solid #EAEAEA;
				padding-bottom: 0.5rem;
			}
			
			#vItem h4 {
				display: block;
				width: 100%;
				font-weight: normal;
			}
			
			#nickName {
				width: 60%;
				color: #C2C2C2;
				font-size: 0.8rem;
				float: left;
			}
			
			#sp_good {
				width: 20%;
				color: #C2C2C2;
				font-size: 0.8rem;
				text-align: right;
				display: block;
				float: left;
			}
			
			#iv_good {
				width: 20px;
				height: 20px;
			}
			
			#sp_comm {
				width: 20%;
				text-align: right;
				float: left;
			}
			
			#iv_comm {
				width: 20px;
				height: 20px;
				margin-right: 0.2rem;
			}
			
			#comBody {
				width: 100%;
				font-size: 0.9rem;
				color: #666;
				line-height: 1.5rem;
				float: left;
				display: block;
			}
			
			#commTime {
				width: 100%;
				font-size: 0.8rem;
				color: #C2C2C2;
				float: left;
				display: block;
			}
			
			#show_newstit {
				font-size: 20px;
			}
			
			#show_newsinfo {
				margin-top: 10px;
			}
			
			.indexnewslist {
				width: 100%;
				float: left;
				margin-top: 3rem;
			}
			
			.newsshow_next {
				font-size: 1rem;
				width: 100%;
				padding-top: 0.5rem;
			}
			
			.newsshow_next h3 {
				width: 100%;
				display: block;
				float: left;
				margin-left: 10px;
				border-bottom: 1px solid #CCC;
			}
			
			.newsshow_next ul.yd {
				width: 100%;
				padding-top: 0.5rem;
				float: left;
				padding-bottom: 0.5rem;
				margin: 0 10px 0 10px;
			}
			
			.newsshow_next ul.yd li {
				width: 100%;
				float: left;
				line-height: 1.5rem;
				overflow: hidden;
				white-space: nowrap;
				text-overflow: ellipsis;
			}
			
			#showvideoinfo_3 {
				margin-left: 10px;
			}
			
			#btn_sub_comm {
				background: #BD0B19;
				color: white;
				border: 0px;
			}
			
			#HiddenFieldId {
				color: #808080;
				font-size: 14px;
			}
			
			.foot li {
				float: left;
				width: 50%;
				text-align: center;
				line-height: 50px;
			}
			
			#topPopover {
				position: absolute;
				top: 16px;
				right: 10px;
				width: 100px;
				background: #000000;
			}
			
			#topPopover .mui-popover-arrow {
				left: auto;
				right: 6px;
			}
			
			#head {
				display: none!important;
			}
		</style>

	</head>

	<body>

		<div class="wrapper">
			<!------------头部--------------->

			<header class="header">
				<div class="head">
					<div class="denglu1 mui-action-back">
						<a><img src="image/into_back.png" style="margin-top:0.2rem;" /></a>
					</div>
					<div class="logo1 mui-action-back">
						<span style="line-height: 25px;">私募动态 </span>
					</div>
					<div class="sousuo1" id="more">
						<a href="#topPopover" class="mui-action-menu"><img src="image/more.png" /></a>
					</div>
				</div>
			</header>

			<!------------新闻详情------------->
			<div class="indexnewslist">
				<div class="newsshow">
					<div class="show">
						<div id="show_newstit" class="newsshow_tit"></div>
						<div id="show_newsinfo" class="newsshow_info"></div>
						<div id="show_newsbody" class="newsshow_body"></div>

						<div class="newsshow_next">
							<h3>相关阅读</h3>
							<ul class="yd" id="data-relate">
							</ul>
						</div>

						<div class="show_videoinfo_pl showvideoinfo_Div" id="showvideoinfo_3" style="background: #efeff4;">
							<h3><em>评论</em><i id="show_Video_CommCount">共0条</i></h3>
							<ul>
								<li>
									<div class="userhead"><img src="image/head.png"></div>
									<div class="form" id="input">
										<a class="showinput">我来说两句</a>
									</div>
								</li>
							</ul>
							<ul id="newscommlist">

							</ul>
							<div class="linkmore">
								<a class="morepinglun" id="getMore" style="display: none;">更多</a>
								<img src="image/loading-0.gif" style="margin: auto;display: none;" id="moreLoad"/>
							</div>

						</div>
					</div>
				</div>
			</div>
			<!------------底部定位层---------->

		</div>
		<!--评论弹出层-->
		<div class="float_comm_input" id="myinput" style="display: none;">
			<div class="left">
				<input type="text" name="HiddenFieldId" id="HiddenFieldId" />
			</div>
			<div class="right">
				<input type="button" id="btn_sub_comm" name="btn_sub_comm" value="发送">
			</div>
		</div>

		<!--右上角弹出菜单-->
		<div id="topPopover" class="mui-popover">
			<div class="mui-popover-arrow"></div>
			<div class="mui-scroll">
				<ul class="mui-table-view">
					<li class="mui-table-view-cell" style="height: 50px;text-align: center;" id="li-collect">
						<span>
								<img   style="width: 30px; height: 30px;line-height: 50px;" id="iv-collect"/>
							<a style="line-height: 50px;">收藏</a></span>
					</li>
					<li class="mui-table-view-cell" id="li-share">
						<span>
								<img   style="width: 30px; height: 30px;" id="iv-share"/>
							<a style="line-height: 30px;">分享</a></span>
					</li>
					<li class="mui-table-view-cell" id="li-more">
						<span>
								<img  style="width: 30px; height: 30px;" id="iv-more"/>
							<a style="line-height: 30px;">更多</a></span>
					</li>
				</ul>
			</div>
		</div>

	</body>

</html>